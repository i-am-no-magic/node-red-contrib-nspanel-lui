<script type="text/javascript" src="resources/node-red-contrib-nspanel-lui/nspanel-lui.js"></script>
<script type="text/javascript">
    ;(function ($) {
        var allValidEvents = [
            { event: 'bExit', label: 'bExit' },
            { event: 'swipeRight', label: 'swipeRight' },
            { event: 'swipeLeft', label: 'swipeLeft' },
            { event: 'swipeUp', label: 'swipeUp' },
            { event: 'swipeDown', label: 'swipeDown' },
        ]

        var editableEventList

        RED.nodes.registerType('nspanel-screensaver', {
            category: 'NSPanel',
            paletteLabel: NSPanelLui._('label.palette', 'nspanel-screensaver'),

            inputs: 1,
            outputs: 1,

            icon: 'font-awesome/fa-television',
            color: 'rgb( 50, 120, 190)',

            defaults: {
                name: { value: NSPanelLui._('defaults.name', 'nspanel-screensaver') },
                nsPanel: { value: '', type: 'nspanel-panel', required: true },
                doubleTapToExit: { value: false },
                timeout: { value: null },

                events: { value: [] },
            },

            label: function () {
                var panelNode = RED.nodes.node(this.nsPanel)

                var label =
                    '[' + (panelNode ? panelNode.name : NSPanelLui._('label.unassigned', 'nspanel-screensaver')) + '] '
                label += this.name || NSPanelLui._('defaults.name', 'nspanel-screensaver')

                return label
            },

            oneditprepare: function () {
                var self = this

                eventInputControl = $('#node-input-event-control')
                nsPanelInputField = $('#node-input-nsPanel')
                var nsPanelInputField_lastVal = this.nsPanel

                nsPanelInputField.on('change', function () {
                    if (nsPanelInputField.val() == '_ADD_') {
                        eventInputControl.hide()
                        //TODO remove all events? ... keep track of original nsPanelId
                    } else {
                        if (nsPanelInputField.val() != nsPanelInputField_lastVal) eventInputControl.empty()
                        eventInputControl.show()
                    }
                })
                nsPanelInputField.change()

                editableEventList = NSPanelLui.Editor.make.editableEventList(
                    this,
                    '#node-input-event-control',
                    allValidEvents,
                    this.events
                )

                var tabs = RED.tabs.create({
                    id: 'nspanel-page-tabs',
                    onchange: function (tab) {
                        $('#nspanel-page-tabs-content').children().hide()
                        $('#' + tab.id).show()
                    },
                })
                tabs.addTab({
                    id: 'nspanel-page-tab-general',
                    iconClass: 'fa fa-cog',
                    label: NSPanelLui._('common.general', 'nspanel-panel'),
                })
                tabs.addTab({
                    id: 'nspanel-page-tab-events',
                    iconClass: 'fa fa-list',
                    label: NSPanelLui._('common.events', 'nspanel-panel'),
                })
            },
            oneditsave: function () {
                this.events = editableEventList.getEvents() || []
            },
        })
    })(jQuery)
</script>

<!--
    config screen
-->
<script type="text/html" data-template-name="nspanel-screensaver">
    <div class="form-row nspanel-page-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="nspanel-page-tabs"></ul>
    </div>
    <div id="nspanel-page-tabs-content" style="min-height: calc(100% - 100px);">
        <div id="nspanel-page-tab-general" style="display:none">
            <div class="form-row">
                <label for="node-input-name">
                    <i class="fa fa-tag"></i>
                    <span data-i18n="nspanel-screensaver.label.name"></span>
                </label>
                <input type="text" id="node-input-name" />
            </div>

            <div class="form-row">
                <label for="node-input-nsPanel">
                    <i class="fa fa-television"></i>
                    <span data-i18n="nspanel-screensaver.label.panel"></span>
                </label>
                <input type="text" id="node-input-nsPanel" />
            </div>

            <div class="form-row">
                <input
                    type="checkbox"
                    id="node-input-doubleTapToExit"
                    style="display:inline-block; width:auto; vertical-align:top;"
                />
                <label for="node-input-doubleTapToExit" style="width:70%;">
                    <span data-i18n="nspanel-screensaver.label.doubleTapToExit"></span>
                </label>
            </div>
        </div>

        <div id="nspanel-page-tab-events" style="display:none">
            <div
                class="form-row node-input-event-control"
                style="min-height: calc(100% - 100px);"
                id="node-input-event-control"
            >
                <div class="form-row node-input-event-container-row">
                    <ol id="node-input-event-container" style="min-height: 300px; min-width: 520px"></ol>
                </div>
            </div>
        </div>
    </div>
</script>
