<script type="text/javascript" src="resources/node-red-contrib-nspanel-lui/nspanel-lui.js"></script>
<script type="text/javascript">
    ;(function ($) {
        const allValidEvents = [
            { event: 'nav.prev', label: 'nav.prev' },
            { event: 'nav.next', label: 'nav.next' },
        ]

        const MAX_ENTITIES = 2
        var editableEventList, editableEntitiesList

        RED.nodes.registerType('nspanel-page-qr', {
            category: 'NSPanel',
            paletteLabel: NSPanelLui._('label.palette', 'nspanel-page-qr'),

            inputs: 0,
            outputs: 1,

            icon: 'font-awesome/fa-television',
            color: 'rgb( 50, 120, 190)',

            defaults: {
                name: { value: NSPanelLui._('defaults.name', 'nspanel-page-qr') },
                title: { value: '' },
                nsPanel: { type: 'nspanel-panel', required: true },
                timeout: { value: null },
                events: { value: [] },
                entities: { value: [] },
                qrCode: { value: '' },
            },

            label: function () {
                var panelNode = RED.nodes.node(this.nsPanel)

                var label =
                    '[' + (panelNode ? panelNode.name : NSPanelLui._('label.unassigned', 'nspanel-page-qr')) + '] '
                label += this.name || NSPanelLui._('defaults.name', 'nspanel-page-qr')

                return label
            },

            oneditprepare: function () {
                var self = this

                eventInputControl = $('#node-input-event-control')
                nsPanelInputField = $('#node-input-nsPanel')
                var nsPanelInputField_lastVal = this.nsPanel

                nsPanelInputField.on('change', function () {
                    if (nsPanelInputField.val() == '_ADD_') {
                        eventInputControl.hide()
                        //TODO remove all events? ... keep track of original nsPanelId
                    } else {
                        if (nsPanelInputField.val() != nsPanelInputField_lastVal) eventInputControl.empty()
                        eventInputControl.show()
                    }
                })
                nsPanelInputField.change()

                editableEventList = NSPanelLui.Editor.make.editableEventList(
                    this,
                    '#node-input-event-control',
                    allValidEvents,
                    this.events
                )
                editableEntitiesList = NSPanelLui.Editor.make.editableEntitiesList(
                    this,
                    '#node-input-entities-control',
                    MAX_ENTITIES,
                    this.entities,
                    ['text']
                )

                var tabs = RED.tabs.create({
                    id: 'nspanel-page-tabs',
                    onchange: function (tab) {
                        $('#nspanel-page-tabs-content').children().hide()
                        $('#' + tab.id).show()
                    },
                })
                tabs.addTab({
                    id: 'nspanel-page-tab-general',
                    iconClass: 'fa fa-cog',
                    label: NSPanelLui._('common.general', 'nspanel-panel'),
                })
                tabs.addTab({
                    id: 'nspanel-page-tab-entities',
                    iconClass: 'fa fa-list',
                    label: NSPanelLui._('common.entities', 'nspanel-panel'),
                })
                tabs.addTab({
                    id: 'nspanel-page-tab-events',
                    iconClass: 'fa fa-list',
                    label: NSPanelLui._('common.events', 'nspanel-panel'),
                })
            },
            oneditsave: function () {
                this.events = editableEventList.getEvents() || []
                this.entities = editableEntitiesList.getEntities() || []

                if (!NSPanelLui.Editor.validate.stringIsNotNullOrEmpty(this.timeout)) {
                    this.timeout = undefined
                }
            },
        })
    })(jQuery)
</script>

<script type="text/html" data-template-name="nspanel-page-qr">
    <div class="form-row nspanel-page-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="nspanel-page-tabs"></ul>
    </div>

    <div id="nspanel-page-tabs-content" style="min-height: calc(100% - 100px);">
        <div id="nspanel-page-tab-general" style="display:none">
            <div class="form-row">
                <label for="node-input-name" style="vertical-align: middle">
                    <i class="fa fa-tag"></i>
                    <span data-i18n="nspanel-page-qr.label.name"></span>
                </label>
                <input type="text" id="node-input-name" />
            </div>
            <div class="form-row">
                <label for="node-input-nsPanel" style="vertical-align: middle">
                    <i class="fa fa-television"></i>
                    <span data-i18n="nspanel-page-qr.label.panel"></span>
                </label>
                <input type="text" id="node-input-nsPanel" />
            </div>

            <div class="form-row">
                <label for="node-input-title" style="vertical-align: middle">
                    <i class="fa fa-header"></i>
                    <span data-i18n="nspanel-page-qr.label.title"></span>
                </label>
                <input type="text" id="node-input-title" />
            </div>

            <div class="form-row">
                <label for="node-input-qrCode" style="vertical-align: middle">
                    <i class="fa fa-qrcode"></i>
                    <span data-i18n="nspanel-page-qr.label.qrCode"></span>
                </label>
                <input type="text" id="node-input-qrCode" />
            </div>

            <br />
            <div class="form-row">
                <label for="node-input-timeout" style="vertical-align: middle">
                    <i class="fa fa-hourglass-end"></i>
                    <span data-i18n="nspanel-page-qr.label.panelTimeout"></span>
                </label>
                <input type="number" id="node-input-timeout" style="width: 7em;" />
                <label for="node-input-timeout" data-i18n="nspanel-page-qr.label.panelTimeoutSeconds"></label>
            </div>
        </div>

        <div id="nspanel-page-tab-entities" style="display:none">
            <div
                class="form-row node-input-entities-control"
                id="node-input-entities-control"
                style="min-height: calc(100% - 100px);"
            >
                <div class="form-row node-input-entities-container-row">
                    <ol id="node-input-entities-container" style="min-width: 620px"></ol>
                </div>
            </div>
        </div>

        <div id="nspanel-page-tab-events" style="display:none">
            <div
                class="form-row node-input-event-control"
                style="min-height: calc(100% - 100px);"
                id="node-input-event-control"
            >
                <div class="form-row node-input-event-container-row">
                    <ol id="node-input-event-container" style="min-width: 520px"></ol>
                </div>
            </div>
        </div>
    </div>
</script>
